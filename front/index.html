<html>

<header>
    <title>小老虎食堂 - 音乐播放</title>
    <meta charset="utf-8">
    <!-- require APlayer -->
    <link rel="stylesheet" href="APlayer.min.css">
    <script src="APlayer.min.js"></script>
    <!-- require jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</header>

<body>

    <div id="player"></div>


</body>
<script>
    let apiUrl = 'http://127.0.0.1:8080/';

    const ap = new APlayer({
        container: document.getElementById('player'),
        mini: false,
        autoplay: false,
        theme: '#FADFA3',
        loop: 'none',
        order: 'list',
        preload: 'auto',
        volume: 1,
        mutex: true,
        listFolded: false,
        listMaxHeight: 90,
        lrcType: 3,
    });

    function postInf(path, type, msg) {
        fetch(apiUrl + path, {
            mode: "no-cors"
        })
    }

    function loadPlayer() {
        fetch(apiUrl + "getMusicList?erase=0&onlyNew=1").then((res) => {
            if (res.status != 200) {
                alert('获取歌曲列表失败，请重载网页！');
                return;
            }

            let arr = res.json();
            return arr;
        }).then(arr => {
            if (arr == undefined) return;
            let musicList = Array();
            let promiseList = Array();
            arr.forEach((val, index) => {
                let url = "https://api.i-meto.com/meting/api?server=" + (val.music.type == 1 ? 'netease' : "tencent") + "&type=song&id=" + val.music.id + "&r=" + Math.random();
                promiseList.push(fetch(url, {
                        mode: "cors"
                    })
                    .then(resp => {
                        resp.json().then(inf => {

                            if (inf.length <= 0) {
                                postInf(`loadError?id=${val.id}&uin=${val.uin}`, "error", "song can't load");
                                return;
                            }

                            musicList.push({
                                "name": inf[0].title,
                                "artist": inf[0].author,
                                "url": inf[0].url,
                                "cover": inf[0].pic,
                                "lrc": inf[0].lrc,
                                "id": val.id
                            })
                        });
                    }));
            });

            Promise.all(promiseList).then(arg => {
                musicList.sort((x, y) => {
                    return x.id > y.id;
                });
                ap.list.add(musicList);
                ap.list.show();
            })

        })
    }

    // bind event
    ap.on('play', () => {
        let i = ap.list.index;
        let val = ap.list.audios[i];
        console.log(`Now playing : ${i}`, val);
        postInf(`setMusicStatus?id=${val.id}`, "do", "");
    })

    // initialize
    loadPlayer();
    let timerHandler = setInterval((handler) => {
        loadPlayer()
    }, 10000);
</script>


</html>